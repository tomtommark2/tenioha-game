# プロジェクト引継ぎ資料 (To: Next AI Agent)

このファイルは、AIエージェントがチャットを切り替えた際に、プロジェクトの文脈（コンテキスト）を即座に把握するための資料です。
**次のAI担当者は、作業開始前に必ずこのファイルを読んでください。**

## 1. プロジェクト概要
*   **名称:** 英単語学習クリッカーゲーム (Vocab Clicker Game)
*   **目的:** クリッカーゲーム形式で英単語を学習できるWebアプリ。
*   **現状:** Web版としてGitHub Pagesで運用中。PWA対応済み。

## 2. 技術スタック & 構成
*   **構成:** **シングルHTML構成** (`vocab_clicker_game.html`)
    *   CSS, JavaScriptは全てこの1ファイル内に記述されています（保守性を考慮）。
    *   外部ファイルは `data/vocabulary.js` (単語データ), `service_worker.js`, `manifest.json`, `scripts/qrcode.min.js` のみ。
    *   `index.html` は `vocab_clicker_game.html` のコピーです（デプロイ用）。
*   **バックエンド:** Firebase
    *   **Firestore:** ユーザーデータ (`users`), ランキング (`leaderboard`), プロモコード (`promocodes`)
    *   **Auth:** Google認証
    *   **Analytics:** Google Analytics (v2.11以降稼働)

## 3. 重要な開発ルール（絶対遵守）
1.  **言語:** 会話、思考、計画はすべて **日本語** で行うこと。
2.  **デプロイ:** `vocab_clicker_game.html` を修正したら、必ず `index.html` にコピーし、GitHub (`git push`) へデプロイすること。
3.  **ユーザー体験:**
    *   **強制リロード禁止:** 更新が必要な場合でも、勝手にリロードせず、必ずダイアログ (`confirm` や Modal) でユーザーに同意を求めること。
    *   **デザイン:** モバイルファーストを意識。シンプルかつモダンなデザインを維持。
2.  **バージョン管理 (厳守):**
    *   **常に更新:** 修正を加えた場合は、必ずバージョン番号を更新すること。
    *   **形式:** `v2.xx` 形式で、小数点以下第2位を +1 する (例: v2.25 → v2.26)。
3.  **作業プロセス (厳守):**
    *   **提案ファースト:** いきなりコードを修正せず、まずは修正案や改善案を提示すること。
    *   **実行許可:** ユーザーから「実行して下さい」や「修正して下さい」と明示的に言われた場合にのみ、コードの改変を行うこと。

## 4. 現在のステータス (v2.25 - 2026/01/14)
### 実装済み機能
*   **文言変更 (v2.25):** 強制アップデート時のメッセージを、不具合対応のお願いベースのマイルドな表現に変更。
*   **緊急修正 (v2.24):** スクリプト構文エラーによるUIフリーズを修正。
*   **強制アップデート機能 (v2.23):** Firebase (`config/app_settings`) で指定した必須バージョン未満のアプリを強制停止する機能を追加。
*   **期限切れタイマー完全修正 (v2.22):** ページリロード後も正しくロック状態を維持されるよう修正。


*   **ランキング亡霊対策 (v2.20):** ゲスト状態でのスコア送信をブロックし、重複レコードの発生を防止。
*   **Stripe決済導入 (v2.16-v2.19):**
    *   **購入ページ (Hub):** `vocab_clicker_game.html` 内に「購入モーダル (`#purchaseModal`)」を新設。
    *   **Stripe連携:** 買い切り型 (¥1,800)。支払い完了後、サンクスページ (`thankyou_x9z2q5.html`) 経由で自動的にプロモコードを適用。
    *   **Note連携:** メンバーシップやNote記事購入への導線を整理。
    *   **セキュリティ対策:** サンクスページのファイル名難読化と警告表示の実装。
*   **"無限プレミアム"バグ修正 (v2.15):** レガシー移行ロジックを削除。
*   **PWAインストール特典のコード化 (v2.14):** 自動付与廃止、プロモコード `app` （1日間）へ変更。
*   **音声再生の最適化 (v2.13):** AudioContextのBuffer実装へ変更。
*   **半自動アップデート:** ランキング画面でのSWバージョンチェック。

### 既知の仕様・注意点
*   **アプリ版のキャッシュ:** PWAはキャッシュが強いため、更新時は必ず `service_worker.js` のバージョンを上げる必要がある。

## 5. ⚠️ アップデート手順 (Release Checklist) ⚠️
**コードを変更してリリースする際は、以下の手順を必ず守ってください。**
これを忘れると、ユーザー側で「更新されない」「404エラーが出る」等の不具合が発生します。

1.  **本体の更新:** `vocab_clicker_game.html` の修正＆バージョン番号 (`v2.xx`) の更新。
    *   **注意:** バージョン番号は「ランキング画面」と「ヘルプ画面」の2箇所にあります。両方更新してください。
2.  **キャッシュ更新 (必須):** `service_worker.js` 内の `CACHE_NAME` を **同じバージョン番号** に書き換える。
    *   例: `const CACHE_NAME = 'vocab-clicker-v2.16';`
3.  **エントリーポイント同期 (必須):** `vocab_clicker_game.html` の内容を、**`index.html` に丸ごとコピー**する。
    *   GitHub Pagesのルートアクセス (`/`) 用に必要です。
4.  **アップロード:** 上記3ファイル (`vocab.html`, `service_worker.js`, `index.html`) を全てコミット＆プッシュする。

## 6. 次回の課題 / Future Roadmap
### 構想: 学習管理システム (LMS)
*   **目的:** 塾や指導者が生徒の学習状況（習慣・量）を定量的に管理する。
*   **ターゲット:** 親、家庭教師、塾講師。
*   **機能案:**
    *   **生徒側:** 通常通りプレイするだけ（データはFirestoreに蓄積済み）。
    *   **先生側 (Manager):**
        *   専用のダッシュボードWebページ（ゲームとは別UI）。
        *   生徒のUIDを入力して「紐付け」を行う。
        *   **閲覧項目:**
            *   最終プレイ日時（サボり検知）
            *   現在のスコア・ランク
            *   習得単語数
            *   1日あたりのプレイ時間（要: Firestoreへの統計送信強化）

### その他
*   **コード整理:** `vocab_clicker_game.html` が肥大化（5000行超）しているため、機能ごとのモジュール分割や整理を検討。

---
**Good Luck!**
